<!DOCTYPE html>
<html lang="en">
    <head> 
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Checkout Page</title>
    </head>
    <style>
        .product {
            display: grid;
            grid-template-columns: 0.2fr 1fr;
        }
    </style>

    <body>
        

        {% include 'navbar.html' %}

        {% csrf_token %}
        {% if total > 0.0 %}
            {% for item, qty in items %}
                {% if qty > 0 %}
                    <hr>
                    <div class="product">
                        <div class="left-side">
                            <img style="height: 30vh" src="/media/{{ item.product_id }}/img1.webp" alt="product-image">
                        </div>

                        <div class="right-side">
                            <a href="{% url 'product' item.product_id %}">{{ item.name }}    </a>
                            <h4>S$ {{ item.price|floatformat:2 }}</h4>
                            <p>Quantity: {{ qty }}</p>
                                
                            <p>{{ item.description|truncatewords:10 }}</p>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
            <hr>
            <strong>Your Total: S$ {{ total|floatformat:2 }}</strong>

            <script src="https://js.stripe.com/v3/"></script>

            <div class="form-container" style="width: 50%">
                <form id="payment-form" method="POST" action="">

                    <input type="text" name="AddressLine1" id="line1" placeholder="Address Line 1" required/>
                    <input type="text" name="City" id="city" placeholder="City" required/>
                    <input type="text" name="PostCode" id="postal_code" placeholder="Postal Code" required/>

                    <div id="card-element"></div>
                    <button id="submit">Pay</button>
                </form>
            </div>
                
            <script>
                document.addEventListener("DOMContentLoaded", async function () {
                    const stripe = Stripe("pk_test_51Rp61ECiz5Qob8MPz2fKkvsX7PTHrvon8wrBE2jpna2vYdKq621Zg5pvl0W4OEhoRpwsmaiKBzwUGbSA3mhpdEpV00REGIOpI5"); // Replace with your public key
                    const elements = stripe.elements();
                    const card = elements.create("card");
                    card.mount("#card-element");

                const formData = new FormData(document.getElementById("payment-form"));

                const response = await fetch("/checkout/", {
                    method: "POST",
                    body: formData
                });

                const { client_secret } = await response.json();

                document.getElementById("submit").addEventListener("click", async () => {
                    const result = await stripe.confirmCardPayment(client_secret, {
                    payment_method: { card: card }
                    });

                    if (result.error) {
                        alert(result.error.message);
                        window.location.href = "payment_failed";
                    } else {
                        alert("Payment succeeded!");
                        window.location.href = "payment_succeeded";
                    }
                });
                });

                fetch('/checkout/', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                const clientSecret = data.client_secret;

                stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: '/home',
                    },
                    });


                // Confirm payment first
                stripe.confirmCardPayment(clientSecret, {
                    payment_method: { card: card }
                }).then(result => {
                    if (result.error) {
                        alert(result.error.message);
                    } else if (result.paymentIntent.status === "succeeded") {
                        window.location.href = data.redirect_url;
                    }
                });
                });

                fetch('/checkout/')
                    .then(res => res.json())
                    .then(data => {
                        window.location.href = data.url;  // âœ… This redirects the browser
                });


            </script>
        {% else %}
            <p><a href="{% url 'home' %}">Shop</a> to add products to cart</p>

        {% endif %}

        
        
    </body>
</html>