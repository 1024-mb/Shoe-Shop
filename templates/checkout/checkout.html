<!DOCTYPE html>
<html lang="en">
    <head> 
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Checkout Page</title>
    </head>
    <style>
        .product {
            display: grid;
            grid-template-columns: 0.2fr 1fr;
        }
    </style>

    <body>
        

        {% include 'navbar.html' %}

        {% csrf_token %}
        {% if total > 0.0 %}
            {% for item, qty, stock in items %}
                {% if qty > 0 and qty >= stock %}
                    <hr>
                    <div class="product">
                        <div class="left-side">
                            <img style="height: 30vh" src="/media/{{ item.product_id }}/img1.webp" alt="product-image">
                        </div>

                        <div class="right-side">
                            <a href="{% url 'product' item.product_id %}">{{ item.name }}    </a>
                            <h4>S$ {{ item.price|floatformat:2 }}</h4>
                            <p>Quantity: {{ qty }}</p>
                                
                            <p>{{ item.description|truncatewords:10 }}</p>
                        </div>
                    </div>

                {% elif qty > stock %}
                    <hr>
                    <div class="product">
                        <div class="left-side">
                            <img style="height: 30vh" src="/media/{{ item.product_id }}/img1.webp" alt="product-image">
                        </div>

                        <div class="right-side">
                            <a href="{% url 'product' item.product_id %}">{{ item.name }}    </a>
                            <h4>S$ {{ item.price|floatformat:2 }}</h4>
                            <p>Error only {{ stock }}: {{ qty }}</p>
                                
                            <p>{{ item.description|truncatewords:10 }}</p>
                        </div>
                    </div>

                
                {% endif %}


            {% endfor %}
            <hr>
            <strong>Your Total: S$ {{ total|floatformat:2 }}</strong>

            <script src="https://js.stripe.com/v3/"></script>

            <div class="form-container" style="width: 70%">
                <form id="payment-form" method="POST" action="">
                    <p>
                        <input name="address-input" id="address-input" type="text" placeholder="Enter your address" autocomplete="off"/>
                        <ul id="suggestions-list"></ul>
                    </p>

                    <p>
                    <label for="phone">Phone Number</label>
                    <input type="tel" name="phone" id="phone" maxlength="9" oninput="modInput()" placeholder="XXXX XXXX" pattern="[0-9]{4} [0-9]{4}" required/>
                    </p>

                    <p>
                        <div id="card-element"></div>
                    </p>

                    <p>
                        <button id="submit">Pay</button>
                    </p>
                </form>
            </div>
                
            <script>
                const phoneInput = document.getElementById("phone");

                phoneInput.addEventListener("input", (e) => {
                let value = e.target.value.replace(/\s/g, ""); // Remove existing spaces
                if (value.length > 4) {
                    value = value.slice(0, 4) + " " + value.slice(4);
                }
                e.target.value = value;
                });


                document.addEventListener("DOMContentLoaded", async function () {
                    const stripe = Stripe("pk_test_51Rp61ECiz5Qob8MPz2fKkvsX7PTHrvon8wrBE2jpna2vYdKq621Zg5pvl0W4OEhoRpwsmaiKBzwUGbSA3mhpdEpV00REGIOpI5");
                    const elements = stripe.elements();
                    const card = elements.create("card");
                    card.mount("#card-element");

                    // Wait for form submission
                    document.getElementById("submit").addEventListener("click", async (e) => {
                        e.preventDefault(); // Prevent default form submission

                        const formData = new FormData(document.getElementById("payment-form"));

                        try {
                            const response = await fetch("/checkout/", {
                                method: "POST",
                                body: formData
                            });

                            const { client_secret } = await response.json();

                            const result = await stripe.confirmCardPayment(client_secret, {
                                payment_method: { card: card }
                            });

                            if (result.error) {
                                alert(result.error.message);
                                window.location.href = "payment_failed";  // ✅ Use full path
                            } else if (result.paymentIntent.status === "succeeded") {
                                alert("Payment succeeded!");
                                window.location.href = "payment_succeeded";  // ✅ Use full path
                            }
                        } catch (error) {
                            console.error("Payment error:", error);
                            alert("Something went wrong. Please try again.");
                            window.location.href = "payment_failed";
                        }
                    });
                });
            
                const sessionToken = crypto.randomUUID();
                const inputBox = document.getElementById("address-input");
                const suggestionsList = document.getElementById("suggestions-list");
                const API_KEY = "AIzaSyDNZzfTqz-metD4fAhrQ5nIVXAB2TP1fq8";  // Replace with your actual key

                let debounceTimer;
                inputBox.addEventListener("input", () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(fetchSuggestions, 300);
                });

                async function fetchSuggestions() {
                    try {
                        const requestBody = {
                        input: inputBox.value,
                        locationBias: {
                            circle: {
                            center: {
                                latitude: 1.5584,
                                longitude: 103.6670
                            },
                            radius: 50000.0
                            }
                        },
                        sessionToken: sessionToken
                        };

                        const response = await fetch("https://places.googleapis.com/v1/places:autocomplete", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-Goog-Api-Key": "AIzaSyDNZzfTqz-metD4fAhrQ5nIVXAB2TP1fq8",
                            "X-Goog-FieldMask": "suggestions.placePrediction.text.text,suggestions.placePrediction.placeId"
                        },
                        body: JSON.stringify(requestBody)
                        });

                        if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`API error: ${response.status} - ${errorText}`);
                        }

                        const data = await response.json();
                        suggestionsList.innerHTML = "";

                        data.suggestions?.forEach(suggestion => {
                        const text = suggestion.placePrediction?.text?.text;
                        if (text) {
                            const li = document.createElement("li");
                            li.textContent = text;
                            li.onclick = () => {
                            inputBox.value = text;
                            suggestionsList.innerHTML = "";
                            };
                            suggestionsList.appendChild(li);
                        }
                        });

                    } catch (error) {
                        console.error("Autocomplete error:", error);
                        suggestionsList.innerHTML = "<li>Error fetching suggestions</li>";
                    }
                }





            </script>
        {% else %}
            <p><a href="{% url 'home' %}">Shop</a> to add products to cart</p>

        {% endif %}

        
        
    </body>
</html>