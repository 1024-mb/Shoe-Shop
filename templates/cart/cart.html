{% extends 'base.html' %}


{% block content %}


<style>
    .product {
        display: grid;
        grid-template-columns: 0.2fr 1fr;
    }
</style>


<body>
    <h1>Your Cart</h1>

    {% if products|length > 0 %}
        
        <form method="POST" action="">
            {% csrf_token %}
            {% for item, qty, stock, size in products %}
                    <hr>
                    <div class="product">
                        <div class="left-side">
                            <img style="height: 30vh" src="/media/{{ item.product_id }}/img1.webp" alt="product-image">
                        </div>

                        <div class="right-side">
                            <a href="{% url 'product' item.product_id %}">{{ item.name }}    </a>
                            <h4>S$ {{ item.price|floatformat:2}}</h4>

                            <p>Size: {{ size }}</p>


                                {% if stock > 20 %}
                                    <label for="{{ item.product_id }}">Quantity (max 20)</label> 
                                    
                                    <p><input title="{{ item.product_id }}" class="quantity-input" name="{{ item.product_id }}" type="number" value="{{ qty }}" max="20" min="0" data-price="{{ item.price }}">  </p>
                                        
                                {% else %}
                                    <label for="{{ item.product_id }}">Quantity (max {{ stock }})</label>
                                    {% if qty > 0 and qty >= stock and stock != 0 %}
                                        <p style="color:rgb(255, 86, 86)">Youâ€™ve requested more items than are currently available. Please reduce the quantity.</p>

                                    {% elif stock <= 4 %}
                                        <p style="color:red">Sorry, this item is currently out of stock.</p>
                                        
                                    {% endif %}
                                    <p><input title="{{ item.product_id }}" class="quantity-input" name="{{ item.product_id }}" type="number" value="{{ qty }}" max="{{ stock }}" min="0" data-price="{{ item.price }}">  </p>
                                {% endif %}
                            
                            <p>{{ item.description|truncatewords:10 }}</p>
                        </div>
                    </div>

            {% endfor %}
            <hr>
            <p>
                <strong>Your total is:  <span id="total-amt">S$ {{ total|floatformat:2 }}</span> </strong>

                <input type="submit" value="Checkout"></input>
            </p>
        </form>

        <hr>
        <form method="GET" action="/cart/clear_cart/">
            <input type="submit" value="Empty Cart"></input>
        </form>

    {% else %}
    <p><a href="{% url 'home' %}">Shop</a> to add products to cart</p>
    {% endif %}


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const quantityInputs = document.querySelectorAll('.quantity-input');
        const totalDisplay = document.getElementById('total-amt');

        function updateTotal() {
            let total = 0;
            quantityInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const price = parseFloat(input.dataset.price) || 0;
                total += quantity * price;
            });
            totalDisplay.textContent = 'S$ ' + total.toFixed(2);
        }

        quantityInputs.forEach(input => {
            input.addEventListener('input', updateTotal);
        });

        // Initial total calculation
        updateTotal();
    });
</script>
</body>

{% endblock %}